<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSL1FY3NYY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-LSL1FY3NYY');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Interpretation-Understand Your Dreams</title>
    <meta name="description" content="Explore the meanings behind your dreams with our intuitive Dream Interpreter. Enter your dream description and get insights based on common dream symbols.">
    <meta name="keywords" content="dream interpreter, dream interpretation, dream meanings, dream symbols, analyze dreams, understand dreams">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#E88A9D">
    <!-- Cache control headers -->
    <meta http-equiv="Cache-Control" content="max-age=86400">
    <meta http-equiv="Expires" content="86400">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="auth.css">
</head>
<body>
    <header class="header">
        <div class="logo">
            <i class="fas fa-moon"></i>
            <span>Dream Interpreter</span>
        </div>
        <!-- Auth buttons or user account will be injected here by auth.js -->
    </header>

    <div class="container">
        <h1>Dream Interpreter</h1>
        <div class="dream-form">
            <div class="input-group">
                <textarea id="dreamInput" placeholder="Describe your dream in detail..."></textarea>
            </div>
            <button onclick="submitDream()"><i class="fas fa-moon"></i>Interpret Dream</button>
        </div>
        <div id="results" class="empty-state">
            <i class="fas fa-cloud-moon"></i>
            <p>Your dream interpretation will appear here</p>
        </div>
        
        <!-- Dream History section (only visible when logged in) -->
        <div id="dreamHistory" class="dream-history" style="display: none;">
            <h2>Your Dream History</h2>
            <div class="history-list" id="historyList">
                <!-- Dream history items will be added here -->
                <p class="empty-history">No saved dreams yet. Your interpreted dreams will appear here.</p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>© <span id="currentYear"></span> Dream Interpreter. All rights reserved. <a href="privacy-policy.html">Privacy Policy</a></p>
        <p><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer">渝ICP备2024032264号-69</a></p>
        <p>Contact Us: ytsgabcde15@2925.com</p>
    </footer>

    <script src="auth.js"></script>
    <script>
        // Register Service Worker for caching
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Check if app is being launched from installed PWA
        const isInStandaloneMode = () => 
            (window.matchMedia('(display-mode: standalone)').matches) || 
            (window.navigator.standalone) || 
            document.referrer.includes('android-app://');

        if (isInStandaloneMode()) {
            console.log('App is running in standalone mode (installed PWA)');
            // You can add specific behavior for when the app is running as an installed PWA
        }

        // Update copyright year
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Basic and expanded knowledge bases
        let interpretationsKb = {};
        let expandedKb = {};
        
        // Dream history storage
        const DREAM_HISTORY_KEY = 'dream_history';
        // User trial count storage
        const DREAM_TRIAL_COUNT_KEY = 'dream_trial_count';
        const TRIAL_TIMESTAMP_KEY = 'dream_trial_timestamp';
        
        // Asynchronously load knowledge bases
        async function loadKnowledgeBases() {
            try {
                // Check if cached data exists
                const cachedKb = localStorage.getItem('cached_kb');
                const cachedTimestamp = localStorage.getItem('cached_kb_timestamp');
                const currentTime = new Date().getTime();
                
                // Use cached data if it's less than 24 hours old
                if (cachedKb && cachedTimestamp && (currentTime - parseInt(cachedTimestamp) < 86400000)) {
                    console.log('Using cached knowledge base');
                    const parsedCache = JSON.parse(cachedKb);
                    interpretationsKb = parsedCache.basic || {};
                    expandedKb = parsedCache.expanded || {};
                    
                    // Still load data in background for next visit
                    setTimeout(() => fetchAndCacheKnowledgeBases(), 2000);
                    return;
                }
                
                // No valid cache, load from network
                await fetchAndCacheKnowledgeBases();
                
            } catch (error) {
                console.error('Error in knowledge base loading process:', error);
                
                // Try to use cached data even if it's older than 24 hours
                const cachedKb = localStorage.getItem('cached_kb');
                if (cachedKb) {
                    console.log('Using older cached knowledge base as fallback');
                    const parsedCache = JSON.parse(cachedKb);
                    interpretationsKb = parsedCache.basic || {};
                    expandedKb = parsedCache.expanded || {};
                }
            }
        }
        
        // Fetch and cache knowledge bases
        async function fetchAndCacheKnowledgeBases() {
            try {
                // Load basic knowledge base
                const basicResponse = await fetch('interpretations.json');
                if (basicResponse.ok) {
                    interpretationsKb = await basicResponse.json();
                    console.log('Basic knowledge base loaded successfully');
                } else {
                    console.error('Failed to load basic interpretations');
                }

                // Try to load the new expanded knowledge base first
                try {
                    const newExpandedResponse = await fetch('interpretations-expanded-new.json');
                    if (newExpandedResponse.ok) {
                        expandedKb = await newExpandedResponse.json();
                        console.log('New expanded knowledge base loaded successfully');
                    } else {
                        // Fall back to the original expanded knowledge base
                        const expandedResponse = await fetch('interpretations-expanded.json');
                        if (expandedResponse.ok) {
                            expandedKb = await expandedResponse.json();
                            console.log('Original expanded knowledge base loaded successfully');
                        } else {
                            console.error('Failed to load any expanded interpretations');
                            // As a last resort, try to load from JS file
                            try {
                                const moduleScript = document.createElement('script');
                                moduleScript.type = 'module';
                                moduleScript.textContent = `
                                    import dreamInterpretations from './interpretations-expanded.js';
                                    window.expandedKb = dreamInterpretations;
                                    console.log('Expanded knowledge base loaded from JS module');
                                `;
                                document.head.appendChild(moduleScript);
                            } catch (jsError) {
                                console.error('Failed to load expanded interpretations from JS:', jsError);
                            }
                        }
                    }
                } catch (newError) {
                    console.error('Error loading new expanded knowledge base:', newError);
                    // Fall back to the original expanded knowledge base
                    try {
                        const expandedResponse = await fetch('interpretations-expanded.json');
                        if (expandedResponse.ok) {
                            expandedKb = await expandedResponse.json();
                            console.log('Original expanded knowledge base loaded successfully');
                        } else {
                            console.error('Failed to load any expanded interpretations');
                        }
                    } catch (fallbackError) {
                        console.error('Error loading fallback expanded knowledge base:', fallbackError);
                    }
                }

                // Cache the knowledge bases
                localStorage.setItem('cached_kb', JSON.stringify({
                    basic: interpretationsKb,
                    expanded: expandedKb
                }));
                localStorage.setItem('cached_kb_timestamp', new Date().getTime().toString());
                console.log('Knowledge base cached successfully');
                
            } catch (error) {
                console.error('Error in knowledge base loading process:', error);
            }
        }

        // Initialize knowledge bases on page load
        window.onload = function() {
            document.getElementById('dreamInput').focus();
            loadKnowledgeBases();
            loadDreamHistory();
        };

        // Deep search expanded knowledge base - improved version
        function searchExpandedKb(keyword) {
            const results = [];
            const keywordLower = keyword.toLowerCase();

            function searchObject(obj, path = []) {
                for (const [key, value] of Object.entries(obj)) {
                    const currentPath = [...path, key];
                    const keyLower = key.toLowerCase();

                    // Check if the key itself is a match
                    if (keyLower.includes(keywordLower) ||
                        (typeof value === 'string' && value.toLowerCase().includes(keywordLower))) {
                        results.push({
                            path: currentPath,
                            key: key,
                            value: typeof value === 'string' ? value : key,
                            fullPath: currentPath.join(' > '),
                            relevance: keyLower === keywordLower ? 1.0 :
                                      keyLower.includes(keywordLower) ? 0.9 : 0.7
                        });
                    }

                    // Continue searching if value is an object
                    if (typeof value === 'object' && value !== null) {
                        searchObject(value, currentPath);
                    }
                }
            }

            searchObject(expandedKb);

            // Sort by relevance
            results.sort((a, b) => b.relevance - a.relevance);
            return results;
        }

        // Search for keywords in dream text
        function findKeywordsInDream(dreamText) {
            const dreamTextLower = dreamText.toLowerCase();
            const matchedKeywords = [];
            const matchedInterpretations = [];

            // First check basic interpretations (flat structure)
            for (const keyword in interpretationsKb) {
                const keywordLower = keyword.toLowerCase();
                if (dreamTextLower.includes(keywordLower)) {
                    matchedKeywords.push(keyword);
                    matchedInterpretations.push({
                        keyword: keyword,
                        interpretation: interpretationsKb[keyword],
                        relevance: 1.0,
                        source: 'basic'
                    });
                }
            }

            // Split text into words
            const words = dreamTextLower.split(/\s+/);

            // Filter for significant words (longer than 2 characters)
            const significantWords = words.filter(word => word.length >= 2);

            // Search for significant words and phrases
            for (const word of significantWords) {
                const expandedResults = searchExpandedKb(word);
                for (const result of expandedResults) {
                    // Avoid duplicates
                    if (!matchedInterpretations.some(item =>
                        item.keyword === result.key &&
                        item.interpretation === result.value)) {
                        matchedKeywords.push(result.key);
                        matchedInterpretations.push({
                            keyword: result.key,
                            interpretation: result.value,
                            relevance: result.relevance,
                            category: result.fullPath,
                            source: 'expanded'
                        });
                    }
                }
            }

            // Search for common phrases (2-3 words)
            for (let i = 0; i < words.length - 1; i++) {
                const phrase2 = words[i] + ' ' + words[i+1];
                if (phrase2.length > 5) {
                    const phraseResults = searchExpandedKb(phrase2);
                    for (const result of phraseResults) {
                        if (!matchedInterpretations.some(item => item.keyword === result.key)) {
                            matchedKeywords.push(result.key);
                            matchedInterpretations.push({
                                keyword: result.key,
                                interpretation: result.value,
                                relevance: result.relevance * 1.2, // Boost for phrases
                                category: result.fullPath,
                                source: 'expanded'
                            });
                        }
                    }
                }

                // 3-word phrases
                if (i < words.length - 2) {
                    const phrase3 = words[i] + ' ' + words[i+1] + ' ' + words[i+2];
                    if (phrase3.length > 8) {
                        const phraseResults = searchExpandedKb(phrase3);
                        for (const result of phraseResults) {
                            if (!matchedInterpretations.some(item => item.keyword === result.key)) {
                                matchedKeywords.push(result.key);
                                matchedInterpretations.push({
                                    keyword: result.key,
                                    interpretation: result.value,
                                    relevance: result.relevance * 1.5, // Higher boost for longer phrases
                                    category: result.fullPath,
                                    source: 'expanded'
                                });
                            }
                        }
                    }
                }
            }

            // Sort by relevance and limit results
            matchedInterpretations.sort((a, b) => b.relevance - a.relevance);
            return {
                keywords: [...new Set(matchedKeywords)], // Remove duplicates
                interpretations: matchedInterpretations.slice(0, 8) // Limit to top 8 results
            };
        }

        // Context association analysis
        function analyzeContext(dreamText, matchedKeywords) {
            const contextualInsights = [];
            const dreamTextLower = dreamText.toLowerCase();

            // Emotion analysis
            const emotionPatterns = {
                positive: ['happy', 'joy', 'excited', 'peaceful', 'calm', 'love'],
                negative: ['scared', 'fear', 'anxiety', 'sad', 'angry', 'upset', 'stress'],
                neutral: ['confused', 'wondering', 'thinking']
            };

            let dominantEmotion = 'neutral';
            let maxEmotionCount = 0;

            for (const [emotion, words] of Object.entries(emotionPatterns)) {
                const count = words.filter(word => dreamTextLower.includes(word)).length;
                if (count > maxEmotionCount) {
                    maxEmotionCount = count;
                    dominantEmotion = emotion;
                }
            }

            // Association analysis - check combinations of symbols
            if (matchedKeywords.length >= 2) {
                // Water + Falling combination
                if (matchedKeywords.some(k => k.toLowerCase().includes('water')) &&
                    matchedKeywords.some(k => k.toLowerCase().includes('falling'))) {
                    contextualInsights.push({
                        combination: "Water and Falling",
                        insight: "The combination of water and falling may indicate emotional instability or concerns about losing control. This might reflect challenges you're facing in managing emotional changes."
                    });
                }

                // Flying + Chase combination
                if (matchedKeywords.some(k => k.toLowerCase().includes('fly')) &&
                    matchedKeywords.some(k => k.toLowerCase().includes('chase'))) {
                    contextualInsights.push({
                        combination: "Flying and Being Chased",
                        insight: "Flying while being chased suggests a tension between seeking freedom and escaping from pressures or responsibilities. Consider what you might be trying to rise above or escape from in your waking life."
                    });
                }

                // House + Unknown rooms combination
                if (matchedKeywords.some(k => k.toLowerCase().includes('house')) &&
                    (dreamTextLower.includes('room') || dreamTextLower.includes('rooms'))) {
                    contextualInsights.push({
                        combination: "House with Unknown Rooms",
                        insight: "Discovering new rooms in a house often represents unexplored aspects of yourself or untapped potential. This may indicate a period of self-discovery or personal growth."
                    });
                }

                // Water + Boat combination
                if (matchedKeywords.some(k => k.toLowerCase().includes('water')) &&
                    matchedKeywords.some(k => k.toLowerCase().includes('boat'))) {
                    contextualInsights.push({
                        combination: "Water and Boat",
                        insight: "The combination of water and a boat suggests you're navigating through emotional situations or life transitions. The state of the water and your ability to reach the boat may reflect how you feel about your emotional journey or life direction."
                    });
                }

                // Sky + Transformation combination
                if (matchedKeywords.some(k => k.toLowerCase().includes('sky')) &&
                    (dreamTextLower.includes('transform') || dreamTextLower.includes('change') || dreamTextLower.includes('turned'))) {
                    contextualInsights.push({
                        combination: "Sky Transformation",
                        insight: "A transforming sky often represents shifting perspectives or awareness. This may indicate you're experiencing a change in how you view your life's possibilities or spiritual outlook."
                    });
                }

                // Bird + Shoulder combination
                if ((matchedKeywords.some(k => k.toLowerCase().includes('bird')) ||
                     matchedKeywords.some(k => k.toLowerCase().includes('seagull'))) &&
                    dreamTextLower.includes('shoulder')) {
                    contextualInsights.push({
                        combination: "Bird on Shoulder",
                        insight: "A bird landing on your shoulder suggests a message from your unconscious or intuition trying to communicate with you. The bird's behavior and your reaction to it may provide clues about what aspect of yourself is seeking attention."
                    });
                }

                // Anxiety + Receding Water combination
                if (dreamTextLower.includes('anxious') &&
                    (matchedKeywords.some(k => k.toLowerCase().includes('receding')) ||
                     (dreamTextLower.includes('water') && dreamTextLower.includes('receded')))) {
                    contextualInsights.push({
                        combination: "Anxiety and Receding Water",
                        insight: "Feeling anxious as water recedes suggests concerns about missed opportunities or feeling that something desirable is moving beyond your reach. This may reflect current situations where you feel things are slipping away from you."
                    });
                }
            }

            return {
                dominantEmotion,
                contextualInsights
            };
        }

        // Generate reflection questions
        function generateReflectionQuestions(dreamText, matchedKeywords) {
            const questions = [];
            const dreamTextLower = dreamText.toLowerCase();

            // Emotion exploration questions
            if (dreamTextLower.includes('fear') || dreamTextLower.includes('scared') ||
                dreamTextLower.includes('anxiety') || matchedKeywords.includes('chase') ||
                matchedKeywords.includes('falling')) {
                questions.push("How might the fear or anxiety in your dream relate to situations in your recent life?");
            }

            // Character relationship questions
            if (dreamTextLower.includes('friend') || dreamTextLower.includes('family') ||
                dreamTextLower.includes('mother') || dreamTextLower.includes('father') ||
                dreamTextLower.includes('partner')) {
                questions.push("What aspects or qualities of yourself might the characters in your dream represent?");
            }

            // Symbol meaning questions
            if (matchedKeywords.length > 0) {
                const randomKeyword = matchedKeywords[Math.floor(Math.random() * matchedKeywords.length)];
                questions.push(`What personal significance or associations does the "${randomKeyword}" in your dream have for you?`);
            }

            // Behavior pattern questions
            if (dreamTextLower.includes('try') || dreamTextLower.includes('could not') ||
                dreamTextLower.includes('failed') || dreamTextLower.includes('struggle')) {
                questions.push("How is your approach to challenges in the dream similar to or different from your approach in waking life?");
            }

            // General questions
            const generalQuestions = [
                "What feelings did this dream evoke, and how might they connect to your current life situation?",
                "If this dream were conveying a message, what do you think that message might be?",
                "What was the most prominent or striking element in your dream, and what might it represent in your life?"
            ];

            // Ensure at least 3 questions
            while (questions.length < 3) {
                const randomQuestion = generalQuestions[Math.floor(Math.random() * generalQuestions.length)];
                if (!questions.includes(randomQuestion)) {
                    questions.push(randomQuestion);
                }
            }

            return questions.slice(0, 3); // Return max 3 questions
        }

        // Add psychological perspectives interpretation
        function getPsychologicalPerspectives(dreamText, matchedKeywords) {
            const dreamTextLower = dreamText.toLowerCase();
            const perspectives = [];

            // Freudian perspective
            if (matchedKeywords.some(k =>
                ['teeth', 'falling', 'flying', 'naked', 'chase'].some(term => k.includes(term)))) {
                perspectives.push({
                    theory: "Freudian Psychoanalysis",
                    interpretation: "From a Freudian perspective, this dream may reflect unconscious desires or conflicts. The symbols in your dream could be disguised expressions of repressed emotions or wishes."
                });
            }

            // Jungian perspective
            if (matchedKeywords.some(k =>
                ['water', 'snake', 'circle', 'old', 'wise', 'shadow', 'sky', 'star', 'bird', 'seagull', 'boat', 'transformation'].some(term => k.toLowerCase().includes(term))) ||
                (dreamTextLower.includes('transform') && dreamTextLower.includes('sky'))) {
                perspectives.push({
                    theory: "Jungian Analytical Psychology",
                    interpretation: "From a Jungian perspective, the elements in your dream may represent archetypes from the collective unconscious. The transforming sky, water, and bird symbolism suggest a connection to the Self archetype and the process of individuation. These symbols might reflect your journey toward greater self-awareness and inner integration."
                });
            }

            // Modern cognitive perspective
            if (dreamTextLower.includes('recent') ||
                dreamTextLower.includes('yesterday') ||
                dreamTextLower.includes('week') ||
                matchedKeywords.some(k => ['exam', 'work', 'study'].some(term => k.includes(term)))) {
                perspectives.push({
                    theory: "Modern Cognitive Psychology",
                    interpretation: "From a cognitive psychology perspective, this dream may be part of your brain's process of organizing and integrating recent memories and emotions. The dream content likely reflects recent events and associated feelings."
                });
            }

            // If no specific theory matches, provide a generic psychological perspective
            if (perspectives.length === 0) {
                perspectives.push({
                    theory: "Integrative Psychological Perspective",
                    interpretation: "From an integrative psychological viewpoint, dreams are a form of unconscious expression that may reflect your inner emotional state, unresolved issues, or directions for personal growth."
                });
            }

            return perspectives;
        }

        // Dream interpretation API function
        async function getDreamInterpretation(dreamText) {
            try {
                // Check for cached interpretation
                const cachedInterpretations = localStorage.getItem('cached_interpretations');
                if (cachedInterpretations) {
                    const interpretations = JSON.parse(cachedInterpretations);
                    // Find exact match (exact same dream text)
                    const exactMatch = interpretations.find(item => item.dreamText === dreamText);
                    if (exactMatch) {
                        console.log('Using cached interpretation');
                        return exactMatch.interpretation;
                    }
                }
                
                const formData = new FormData();
                const google_id = localStorage.getItem('google_id');
                formData.append('google_id', google_id || '');
                formData.append('model_id', '4');  // Using text interpretation model
                
                const content = `Please interpret the following dream content: ${dreamText}`;
                formData.append('content', content);
                
                // Show loading state
                const resultsDiv = document.getElementById('results');
                resultsDiv.className = 'loading';
                resultsDiv.innerHTML = '<div class="loader"></div><p>Interpreting your dream...</p>';
        
                // Send request to AI API
                const response = await fetch('https://aa.jstang.cn/api/ai/call', {
                    method: 'POST',
                    body: formData,
                });
        
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                }
        
                const data = await response.json();
                console.log('AI interpretation result:', data);
        
                // Process AI response
                if (data && data.data) {
                    // Cache the interpretation
                    let interpretations = [];
                    const cachedData = localStorage.getItem('cached_interpretations');
                    if (cachedData) {
                        interpretations = JSON.parse(cachedData);
                    }
                    
                    // Add new interpretation to cache
                    interpretations.push({
                        dreamText: dreamText,
                        interpretation: data.data,
                        timestamp: new Date().getTime()
                    });
                    
                    // Limit cache size to 50 items
                    if (interpretations.length > 50) {
                        interpretations = interpretations.slice(interpretations.length - 50);
                    }
                    
                    localStorage.setItem('cached_interpretations', JSON.stringify(interpretations));
                    
                    return data.data;
                } else {
                    throw new Error(`AI did not return valid interpretation results: ${JSON.stringify(data)}`);
                }
        
            } catch (error) {
                console.error('Failed to get AI interpretation:', error);
                throw error;
            }
        }

        // Submit dream for interpretation
        function submitDream() {
            console.log('submitDream function called');

            const dreamText = document.getElementById('dreamInput').value;
            const resultsDiv = document.getElementById('results');

            if (!dreamText.trim()) {
                resultsDiv.className = '';
                resultsDiv.innerHTML = '<div class="error"><i class="fas fa-exclamation-circle"></i>Please enter your dream description!</div>';
                return;
            }

            // Check trial count if user is not logged in
            if (!isLoggedIn()) {
                const trialCount = getTrialCount();
                
                if (trialCount >= 20) {
                    // Show login prompt when trial count exceeds 20
                    resultsDiv.className = '';
                    resultsDiv.innerHTML = `
                        <div class="login-prompt">
                            <i class="fas fa-lock"></i>
                            <h3>Free Trial Limit Reached</h3>
                            <p>You've used all your free interpretations (20). Login to enjoy more free interpretations!</p>
                            <div class="login-prompt-buttons">
                                <a href="login.html" class="login-button">Login</a>
                                <a href="register.html" class="register-button">Sign Up</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Increment trial count
                incrementTrialCount();
            }

            // Show loading state
            resultsDiv.className = 'loading';
            resultsDiv.innerHTML = '<div class="loader"></div><p>Interpreting your dream...</p>';

            setTimeout(async () => {
                console.log('setTimeout callback function called');
                try {
                    // Get AI interpretation result
                    const aiInterpretation = await getDreamInterpretation(dreamText);
                    
                    // Use existing keyword analysis
                    const dreamAnalysis = findKeywordsInDream(dreamText);
                    const matchedKeywords = dreamAnalysis.keywords;
                    let matchedInterpretations = dreamAnalysis.interpretations;
        
                    // Create interpretation result card
                    const aiInterpDiv = document.createElement('div');
                    aiInterpDiv.className = 'interpretation-card ai-interpretation';
                    aiInterpDiv.innerHTML = `
                        <h3><i class="fas fa-robot"></i> Dream Interpretation</h3>
                        <p>${aiInterpretation}</p>
                    `;
        
                    // Clear and display results
                    resultsDiv.className = '';
                    resultsDiv.innerHTML = '';
                    resultsDiv.appendChild(aiInterpDiv);
                    
                    // If user is logged in, save dream to history
                    if (isLoggedIn()) {
                        saveDreamToHistory(dreamText, aiInterpretation);
                    }
                    
                } catch (error) {
                    console.error('Interpretation process error:', error);
                    resultsDiv.className = '';
                    resultsDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i>Dream interpretation failed: ${error.message}</div>`;
                }
            }, 800);
        }
        
        // Dream history functions
        function loadDreamHistory() {
            if (!isLoggedIn()) {
                document.getElementById('dreamHistory').style.display = 'none';
                return;
            }
            
            // Show dream history section
            document.getElementById('dreamHistory').style.display = 'block';
            
            // Get dream history from localStorage
            const history = getDreamHistory();
            const historyList = document.getElementById('historyList');
            
            // Clear existing content
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="empty-history">No saved dreams yet. Your interpreted dreams will appear here.</p>';
                return;
            }
            
            // Display dream history
            history.forEach((dream, index) => {
                const dreamItem = document.createElement('div');
                dreamItem.className = 'history-item';
                dreamItem.innerHTML = `
                    <div class="history-dream">
                        <h3>Dream ${index + 1}</h3>
                        <p>${dream.dreamText.substring(0, 100)}${dream.dreamText.length > 100 ? '...' : ''}</p>
                        <div class="history-date">${new Date(dream.date).toLocaleDateString()}</div>
                    </div>
                    <div class="history-actions">
                        <button class="view-btn" data-index="${index}">View</button>
                        <button class="delete-btn" data-index="${index}">Delete</button>
                    </div>
                `;
                historyList.appendChild(dreamItem);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    viewDreamFromHistory(index);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    deleteDreamFromHistory(index);
                });
            });
        }
        
        function getDreamHistory() {
            const history = localStorage.getItem(DREAM_HISTORY_KEY);
            return history ? JSON.parse(history) : [];
        }
        
        function saveDreamToHistory(dreamText, interpretation) {
            const history = getDreamHistory();
            
            // Add new dream to history
            history.unshift({
                dreamText,
                interpretation,
                date: new Date().toISOString()
            });
            
            // Limit history size
            const limitedHistory = history.slice(0, 10);
            
            // Save to localStorage
            localStorage.setItem(DREAM_HISTORY_KEY, JSON.stringify(limitedHistory));
            
            // Reload dream history
            loadDreamHistory();
        }
        
        function viewDreamFromHistory(index) {
            const history = getDreamHistory();
            const dream = history[index];
            
            if (!dream) return;
            
            // Display dream in results
            const resultsDiv = document.getElementById('results');
            resultsDiv.className = '';
            
            const aiInterpDiv = document.createElement('div');
            aiInterpDiv.className = 'interpretation-card ai-interpretation';
            aiInterpDiv.innerHTML = `
                <h3><i class="fas fa-robot"></i> Dream Interpretation</h3>
                <p>${dream.interpretation}</p>
            `;
            
            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(aiInterpDiv);
            
            // Set dream text in input
            document.getElementById('dreamInput').value = dream.dreamText;
        }
        
        function deleteDreamFromHistory(index) {
            const history = getDreamHistory();
            
            // Remove dream from history
            history.splice(index, 1);
            
            // Save to localStorage
            localStorage.setItem(DREAM_HISTORY_KEY, JSON.stringify(history));
            
            // Reload dream history
            loadDreamHistory();
        }

        // Get trial count from localStorage
        function getTrialCount() {
            // Check if trial count should be reset (after 30 days)
            const timestamp = localStorage.getItem(TRIAL_TIMESTAMP_KEY);
            const currentTime = new Date().getTime();
            
            if (!timestamp || (currentTime - parseInt(timestamp)) > 30 * 24 * 60 * 60 * 1000) {
                // Reset trial count after 30 days
                localStorage.setItem(DREAM_TRIAL_COUNT_KEY, '0');
                localStorage.setItem(TRIAL_TIMESTAMP_KEY, currentTime.toString());
                return 0;
            }
            
            const count = localStorage.getItem(DREAM_TRIAL_COUNT_KEY);
            return count ? parseInt(count) : 0;
        }
        
        // Increment trial count
        function incrementTrialCount() {
            const currentCount = getTrialCount();
            localStorage.setItem(DREAM_TRIAL_COUNT_KEY, (currentCount + 1).toString());
            
            // Update timestamp if not set
            if (!localStorage.getItem(TRIAL_TIMESTAMP_KEY)) {
                localStorage.setItem(TRIAL_TIMESTAMP_KEY, new Date().getTime().toString());
            }
            
            return currentCount + 1;
        }
    </script>
</body>
</html>











